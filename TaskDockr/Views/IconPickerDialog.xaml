<Window
    x:Class="TaskDockr.Views.IconPickerDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="clr-namespace:TaskDockr.Views"
    Title="Choose Icon"
    Width="680" Height="520"
    WindowStartupLocation="CenterOwner"
    ResizeMode="NoResize"
    ShowInTaskbar="False"
    Background="#1E1E1E"
    Icon="/Assets/AppIcon.ico">

    <Window.Resources>
        <!-- Convert string to bool for visibility -->
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="160" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Left Sidebar: Categories -->
        <Border Grid.Column="0" Background="#171717" BorderBrush="#333" BorderThickness="0,0,1,0">
            <ListBox x:Name="CategoryList"
                     ItemsSource="{Binding Categories}"
                     SelectedItem="{Binding SelectedCategory}"
                     Background="Transparent"
                     BorderThickness="0"
                     Padding="4,8">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Foreground" Value="#CCCCCC" />
                        <Setter Property="FontSize" Value="13" />
                        <Setter Property="Padding" Value="12,8" />
                        <Setter Property="Margin" Value="2,1" />
                        <Setter Property="Cursor" Value="Hand" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border x:Name="Bd" Background="Transparent"
                                            CornerRadius="6" Padding="{TemplateBinding Padding}"
                                            Margin="{TemplateBinding Margin}">
                                        <ContentPresenter />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="#2A2A2A" />
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="#333333" />
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
            </ListBox>
        </Border>

        <!-- Right Content Area -->
        <Grid Grid.Column="1" Margin="16,12,16,12">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />  <!-- Search + Color -->
                <RowDefinition Height="*" />      <!-- Icon grid or file browse -->
                <RowDefinition Height="Auto" />   <!-- Buttons -->
            </Grid.RowDefinitions>

            <!-- Search bar + color row -->
            <StackPanel Grid.Row="0" Margin="0,0,0,10">
                <!-- Search -->
                <TextBox x:Name="SearchBox"
                         Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                         Background="#2A2A2A" Foreground="White"
                         BorderBrush="#444" BorderThickness="1"
                         Padding="10,8" FontSize="13"
                         Margin="0,0,0,8" />

                <!-- Color picker row -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock Text="Color:" Foreground="#999" VerticalAlignment="Center"
                               Margin="0,0,8,0" FontSize="12" />
                    <ItemsControl ItemsSource="{Binding PresetColors}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Width="24" Height="24" CornerRadius="12"
                                        Margin="2,0" Cursor="Hand"
                                        BorderThickness="2" BorderBrush="Transparent"
                                        MouseLeftButtonDown="OnColorClick">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding}" />
                                    </Border.Background>
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="BorderBrush" Value="#888" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <TextBox Text="{Binding SelectedColor, UpdateSourceTrigger=PropertyChanged}"
                             Width="80" Margin="8,0,0,0"
                             Background="#2A2A2A" Foreground="White"
                             BorderBrush="#444" BorderThickness="1"
                             Padding="6,4" FontSize="12"
                             VerticalAlignment="Center" />
                </StackPanel>
            </StackPanel>

            <!-- Icon Grid (visible when not "Use My Own") -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Visibility="{Binding IsIconGrid, Converter={StaticResource BoolToVis}}">
                <ItemsControl ItemsSource="{Binding DisplayedIcons}"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border x:Name="IconTile" Width="72" Height="72"
                                    CornerRadius="6" Margin="3"
                                    Background="#252525" Cursor="Hand"
                                    BorderThickness="2" BorderBrush="Transparent"
                                    MouseLeftButtonDown="OnIconClick"
                                    ToolTip="{Binding Name}">
                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                    <TextBlock x:Name="GlyphText"
                                               Text="&#xf015;"
                                               FontSize="22"
                                               Foreground="White"
                                               HorizontalAlignment="Center"
                                               Loaded="OnGlyphLoaded" />
                                    <TextBlock Text="{Binding Name}"
                                               Foreground="#999" FontSize="9"
                                               HorizontalAlignment="Center"
                                               Margin="0,4,0,0"
                                               MaxWidth="64"
                                               TextTrimming="CharacterEllipsis" />
                                </StackPanel>
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#333" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- File Browse panel (visible when "Use My Own") -->
            <StackPanel Grid.Row="1" VerticalAlignment="Center"
                        Visibility="{Binding IsUseMyOwn, Converter={StaticResource BoolToVis}}">
                <TextBlock Text="Browse for a custom icon file"
                           Foreground="#999" FontSize="14"
                           HorizontalAlignment="Center" Margin="0,0,0,16" />
                <Grid HorizontalAlignment="Center" Width="400">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0"
                             Text="{Binding CustomIconPath, UpdateSourceTrigger=PropertyChanged}"
                             Background="#2A2A2A" Foreground="White"
                             BorderBrush="#444" BorderThickness="1"
                             Padding="8,6" FontSize="13" Margin="0,0,8,0" />
                    <Button Grid.Column="1" Content="Browse..."
                            Command="{Binding BrowseFileCommand}"
                            Background="#333" Foreground="White"
                            Padding="16,6" FontSize="13"
                            BorderBrush="#555" BorderThickness="1" />
                </Grid>
            </StackPanel>

            <!-- Footer Buttons -->
            <StackPanel Grid.Row="2" Orientation="Horizontal"
                        HorizontalAlignment="Right" Margin="0,12,0,0">
                <Button Content="Cancel" Margin="0,0,8,0"
                        Command="{Binding CancelCommand}"
                        Background="#333" Foreground="White"
                        Padding="20,8" FontSize="13"
                        BorderBrush="#555" BorderThickness="1" />
                <Button Content="Select Icon"
                        Command="{Binding ConfirmCommand}"
                        IsEnabled="{Binding HasSelection}"
                        Background="{DynamicResource SystemAccentColorBrush}"
                        Foreground="White"
                        Padding="20,8" FontSize="13"
                        BorderThickness="0" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>
