<Window
    x:Class="TaskDockr.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:TaskDockr"
    xmlns:viewmodels="using:TaskDockr.ViewModels"
    xmlns:models="using:TaskDockr.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:TaskDockr.Converters"
    mc:Ignorable="d">
    
    <Window.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <converters:CountToShortcutsTextConverter x:Key="CountToShortcutsTextConverter" />
    </Window.Resources>
    
    <Window.DataContext>
        <viewmodels:MainViewModel />
    </Window.DataContext>

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Modern Title Bar -->
        <Grid Grid.Row="0" Height="48" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <!-- App Title -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="24,0,0,0" VerticalAlignment="Center">
                <FontIcon Glyph="&#xE7FC;" FontSize="20" Margin="0,0,12,0" />
                <TextBlock Text="TaskDockr" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center" />
            </StackPanel>
            
            <!-- Theme Toggle -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <Button x:Name="PopoutButton" Content="Show Popout" Margin="0,0,12,0" Style="{StaticResource DefaultButtonStyle}" Click="OnPopoutButtonClick" />
                <ToggleButton x:Name="ThemeToggle" Content="Theme" Margin="0,0,24,0" Style="{StaticResource DefaultButtonStyle}" Checked="OnThemeToggleChecked" Unchecked="OnThemeToggleUnchecked" />
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Navigation Panel -->
            <Border Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Margin="0,0,1,0" BorderThickness="0,0,1,0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                <Grid Margin="24">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Groups Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,20">
                        <TextBlock Text="Groups" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center" />
                        <Button Content="+" Margin="16,0,0,0" Command="{x:Bind ViewModel.AddGroupCommand}" 
                                Style="{StaticResource IconButtonStyle}" Width="32" Height="32" />
                    </StackPanel>

                    <!-- Groups List -->
                    <ListView x:Name="GroupsListView" Grid.Row="1" ItemsSource="{x:Bind ViewModel.Groups}" SelectionMode="Single" CanReorderItems="True" AllowDrop="True" CanDragItems="True" ItemContainerStyle="{StaticResource FluentListViewItemStyle}">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:Group">
                                <Grid Margin="0,8" Height="44" Background="Transparent">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Drag Handle -->
                                    <Border Grid.Column="0" Background="Transparent" CornerRadius="6" Padding="12">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <FontIcon Glyph="&#xE7FD;" FontSize="16" Margin="0,0,16,0" Opacity="0.5" />
                                            <FontIcon Glyph="&#xE7FC;" FontSize="16" Margin="0,0,16,0" />
                                            <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold" VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Border>
                                    
                                    <Button Grid.Column="1" Content="✏️" Command="{x:Bind ViewModel.EditGroupCommand}" 
                                            CommandParameter="{x:Bind}" Style="{StaticResource IconButtonStyle}" 
                                            Width="32" Height="32" Margin="0,0,8,0" />
                                    
                                    <Button Grid.Column="2" Content="×" Command="{x:Bind ViewModel.DeleteGroupCommand}" 
                                            CommandParameter="{x:Bind}" Style="{StaticResource IconButtonStyle}" 
                                            Width="32" Height="32" />
                                    
                                    <!-- Drag Visual States -->
                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup x:Name="DragStates">
                                            <VisualState x:Name="Normal" />
                                            <VisualState x:Name="DragOver">
                                                <VisualState.Setters>
                                                    <Setter Target="DragOverBorder.Visibility" Value="Visible" />
                                                    <Setter Target="DragOverBorder.Background" Value="{ThemeResource SystemAccentColorLight3}" />
                                                </VisualState.Setters>
                                            </VisualState>
                                            <VisualState x:Name="Dragging">
                                                <VisualState.Setters>
                                                    <Setter Target="DragOverBorder.Visibility" Value="Visible" />
                                                    <Setter Target="DragOverBorder.Background" Value="{ThemeResource SystemAccentColorLight2}" />
                                                    <Setter Target="DragOverBorder.Opacity" Value="0.7" />
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>
                                    
                                    <!-- Drag Overlay -->
                                    <Border x:Name="DragOverBorder" Grid.ColumnSpan="3" Background="Transparent" CornerRadius="6" Visibility="Collapsed" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                     <!-- Navigation Buttons -->
                     <StackPanel Grid.Row="2" Margin="0,20,0,0" Spacing="8">
                         <Button Content="Manage Groups" Click="OnManageGroupsClick" Style="{StaticResource SubtleButtonStyle}" HorizontalAlignment="Stretch" />
                         <Button Content="Settings" Click="OnSettingsClick" Style="{StaticResource SubtleButtonStyle}" HorizontalAlignment="Stretch" />
                     </StackPanel>
                </Grid>
            </Border>

            <!-- Content Area -->
            <Grid Grid.Column="1" Margin="24">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Navigation Frame -->
                <Frame x:Name="MainContentFrame" Grid.RowSpan="2" NavigationFailed="OnNavigationFailed" />

                <!-- Default Content (Hidden when navigation is active) -->
                <Grid Grid.RowSpan="2" Visibility="{x:Bind IsDefaultContentVisible, Mode=OneWay}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Selected Group Header -->
                    <Border Grid.Row="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Margin="0,0,0,20" Padding="20" CornerRadius="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE7FC;" FontSize="24" Margin="0,0,16,0" />
                                <TextBlock Text="Selected Group" FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center" />
                            </StackPanel>
                            
                            <Button Grid.Column="1" Content="Add Shortcut" Command="{x:Bind ViewModel.AddShortcutCommand}" 
                                    CommandParameter="{x:Bind}" Style="{StaticResource AccentButtonStyle}" />
                        </Grid>
                    </Border>

                     <!-- Shortcuts Grid -->
                     <GridView x:Name="ShortcutsGridView" Grid.Row="1" ItemsSource="{x:Bind ViewModel.Groups[0].Shortcuts}" 
                               SelectionMode="None" IsItemClickEnabled="True" CanReorderItems="True" AllowDrop="True" CanDragItems="True" ItemContainerStyle="{StaticResource FluentGridViewItemStyle}">
                     <GridView.ItemTemplate>
                         <DataTemplate x:DataType="models:Shortcut">
                             <Border Style="{StaticResource ShortcutCardStyle}">
                                 <Grid>
                                     <Grid.RowDefinitions>
                                         <RowDefinition Height="Auto" />
                                         <RowDefinition Height="*" />
                                         <RowDefinition Height="Auto" />
                                     </Grid.RowDefinitions>
                                     
                                     <!-- Drag Handle -->
                                     <FontIcon Grid.Row="0" Glyph="&#xE7C3;" FontSize="32" HorizontalAlignment="Center" Margin="0,0,0,8" />
                                     
                                     <StackPanel Grid.Row="1" VerticalAlignment="Center">
                                         <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold" TextAlignment="Center" />
                                         <TextBlock Text="{x:Bind Type}" Opacity="0.7" FontSize="12" TextAlignment="Center" />
                                     </StackPanel>
                                     
                                     <Button Grid.Row="2" Content="×" Command="{x:Bind ViewModel.DeleteShortcutCommand}" 
                                             CommandParameter="{x:Bind}" HorizontalAlignment="Center" 
                                             Style="{StaticResource IconButtonStyle}" Width="24" Height="24" />
                                     
                                     <!-- Drag Visual States -->
                                     <VisualStateManager.VisualStateGroups>
                                         <VisualStateGroup x:Name="ShortcutDragStates">
                                             <VisualState x:Name="Normal" />
                                             <VisualState x:Name="DragOver">
                                                 <VisualState.Setters>
                                                     <Setter Target="ShortcutDragOverlay.Visibility" Value="Visible" />
                                                     <Setter Target="ShortcutDragOverlay.Background" Value="{ThemeResource SystemAccentColorLight3}" />
                                                     <Setter Target="ShortcutDragOverlay.BorderBrush" Value="{ThemeResource SystemAccentColor}" />
                                                 </VisualState.Setters>
                                             </VisualState>
                                             <VisualState x:Name="Dragging">
                                                 <VisualState.Setters>
                                                     <Setter Target="ShortcutDragOverlay.Visibility" Value="Visible" />
                                                     <Setter Target="ShortcutDragOverlay.Background" Value="{ThemeResource SystemAccentColorLight2}" />
                                                     <Setter Target="ShortcutDragOverlay.BorderBrush" Value="{ThemeResource SystemAccentColor}" />
                                                     <Setter Target="ShortcutDragOverlay.Opacity" Value="0.7" />
                                                 </VisualState.Setters>
                                             </VisualState>
                                         </VisualStateGroup>
                                     </VisualStateManager.VisualStateGroups>
                                     
                                     <!-- Drag Overlay -->
                                     <Border x:Name="ShortcutDragOverlay" Grid.RowSpan="3" Background="Transparent" CornerRadius="8" BorderThickness="2" BorderBrush="Transparent" Visibility="Collapsed" />
                                 </Grid>
                             </Border>
                         </DataTemplate>
                     </GridView.ItemTemplate>
                     
                     <GridView.ItemsPanel>
                         <ItemsPanelTemplate>
                             <ItemsWrapGrid Orientation="Horizontal" />
                         </ItemsPanelTemplate>
                     </GridView.ItemsPanel>
                 </GridView>
                     </GridView>
                 </Grid>
             </Grid>
         </Grid>
     </Grid>
 
 </Window>